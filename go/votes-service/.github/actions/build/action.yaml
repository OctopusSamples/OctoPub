name: 'Build'
description: 'Build Go App'
inputs:
  directory:
    description: 'The base directory of the go application'
    required: true
  main:
    description: 'The main file'
    required: true
runs:
  using: "composite"
  steps:
    - uses: actions/setup-go@v2
      with:
        go-version: 1.17
    - run: go get ./...
      shell: bash
      working-directory: "${{ inputs.directory }}"
    - run: go build ${{ inputs.main }}
      shell: bash
      working-directory: "${{ inputs.directory }}"
      env:
        GOOS: linux
        GOARCH: arm64
    - run: zip function-arm64.zip main
      shell: bash
      working-directory: "${{ inputs.directory }}"
    - run: go build ${{ inputs.main }}
      shell: bash
      working-directory: "${{ inputs.directory }}"
      env:
        GOOS: linux
        GOARCH: amd64
    - run: zip function-amd64.zip main
      shell: bash
      working-directory: "${{ inputs.directory }}"
    - run: >
        mvn deploy:deploy-file
        -DrepositoryId=github
        -Dfile=function-amd64.zip
        -Durl=https://maven.pkg.github.com/mcasperson/OctoPub
        -DgroupId=com.octopus.octopub
        -DartifactId=votes-service
        -Dversion=0.0.1.${{ github.run_number }}
      shell: bash
      working-directory: "${{ inputs.directory }}"